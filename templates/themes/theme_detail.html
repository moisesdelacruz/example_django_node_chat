{% extends "base.html" %}

{% block title %}
  {{ object.text|truncatechars:30 }}
{% endblock %}

{% block content %}
  <p>
    <strong>{{ object.user.username }}</strong>
  </p>
  <p>
    {{ object.text }}
  </p>
  <img src="{{ MEDIA_URL }}{{ object.photo.url }}" alt="{{ object.text }}" width="420" height="480" />
  <div>
    <ul id="comments">
        {% for comment in comments %}
            <li><strong>{{comment.user}}:</strong> {{comment.text}}</li>
        {% endfor %}
    </ul>

    <input data-id="{{ object.id }}" type="text" name="comment" id="comment" placeholder="Comment..." />
  </div>


  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script>
  $(document).ready(() => {

    const socket = io.connect('localhost:3000');

    socket.on('connect', () => {
      console.log("connect");
    });

    const entry_el = $('#comment');

    window.scrollBy(0, 10000000000);
    entry_el.focus();

    socket.on('message', (message) => {
      //Escape HTML characters
      // var data = message.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

      //Append message to the bottom of the list
      $('#comments').prepend(`<li><strong>${message.user}: </strong>${message.text}</li>`);
      window.scrollBy(0, 10000000000);
      entry_el.focus();
    });

    entry_el.keypress((event) => {
      //When enter is pressed send input value to node server
      if(event.keyCode != 13) return;
      let msg = entry_el.attr('value');
      let theme = entry_el.data('id');
      if(msg){
         socket.emit('send_message', {'text': msg, 'theme': theme}, (data) => {
              console.log(data);
         });

      //Clear input value
      entry_el.attr('value', '');
     }
    });
  });
  </script>
{% endblock %}
